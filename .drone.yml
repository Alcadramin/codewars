---
kind: pipeline
name: Default

steps:
  - name: Tests
    image: node
    commands:
      - npm ci
      - npm run test

  - name: Generate list
    image: node
    environment:
      TOKEN:
        from_secret: CODEWARS_TOKEN
    commands:
      - npm run build

  - name: Push new list
    image: alpine:latest
    commands:
      - apk add --no-cache openssh-client ca-certificates bash git
      - eval `ssh-agent -s`
      - echo "$KEY" | ssh-add -
      - mkdir -p ~/.ssh
      - echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config
      - git add .
      - git commit -m "CI :\:\ Updated list [skip ci]"
      - git remote set-url origin git@github.com:Alcadramin/codewars.git
      - git push origin main
    environment:
      KEY:
        from_secret: GH_SSH_KEY
